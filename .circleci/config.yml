version: 2.1


## base conf



references:
  workspace_root: &workspace_root
    /tmp/workspace
  attach_workspace: &attach_workspace
    attach_workspace:
      at: *workspace_root

orbs:
  docker-publish: circleci/docker-publish@0.1.1

executors:
    node-executor:
      docker:
        - image: circleci/node:10.14.1-browsers
          user: root

      environment:
        CC_TEST_REPORTER_ID: 1ce2c894983929f01f1a2e38b99f695de00efa01a38043280c6849761de2578a

      working_directory: ~/project

    alpine-executor:
      docker:
        - image: alpine:3.8
          user: root

      working_directory: ~/project

    python-executor:
      docker:
        - image: python:3.7.1
          user: root

      working_directory: ~/project

commands:
  executor-alpine-setup-dependencies:
    description: "Alpine image dependencies install"
    steps:
      - run:
          name: Package manager | update list of available packages
          command: apk update

          # apk add gcc
          # apk add musl-dev
          # apk add make
          # apk add g++
      - run:
          name: Package manager | install packages
          command: |
            apk add build-base
            apk add zip
            apk add curl
            apk add coreutils
            apk add jemalloc-dev
            apk add linux-headers
            apk add cmake
            apk add ca-certificates
            apk add bash
            apk add tcl

      - run:
          name: python / pip install
          command: |
            apk add jq
            apk add py-pip
            pip install yq

  executor-python-setup-dependencies:
    description: "Python image dependencies install"
    steps:
      - run:
          name: Package manager | update list of available packages
          command: apt update

      - run:
          name: Package manager | install packages
          command: |
            apt install jq -y
            apt install build-essential -y
            apt install cmake -y
            apt install zip -y
            apt install libatlas-base-dev -y
            pip install yq

  executor-env-variables:
    description: "Prepare env Variables"
    parameters:
      env-file-name:
        type: string
        default: "new-env-vars"
    steps:
      - run:
          name: Integrating env parameters from << parameters.env-file-name >> into BASH_ENV
          command: |
            cat /tmp/workspace/<< parameters.env-file-name >> >> $BASH_ENV

  libs-external-get:
    description: "TBA"
    parameters:
      base-cache-prefix:
        type: string
        default: v032
      lib-github-org:
        type: string
        default: RedisLabsModules
      lib-name:
        type: string
        default: rejson
      lib-release:
        type: string
      lib-release-package-extension:
        type: string
        default: zip
      lib-category:
        type: string
        default: libs
    steps:
      - run:
          name: Create << parameters.lib-name >> parameters
          command: |
            > lib.version
            echo "base-cache-prefix=<< parameters.base-cache-prefix >>" >>lib.version
            echo "lib-github-org=<< parameters.lib-github-org >>" >>lib.version
            echo "lib-name=<< parameters.lib-name >>" >>lib.version
            echo "lib-release=<< parameters.lib-release >>" >>lib.version
            echo "lib-release-package-extension=<< parameters.lib-release-package-extension >>" >>lib.version
            echo "lib-category=<< parameters.lib-category >>" >>lib.version
            cat lib.version

      - run:
          name: Create << parameters.lib-name >> workspace download directory
          command: mkdir -p /tmp/workspace/download/<< parameters.lib-category >>/<< parameters.lib-name >>

      - restore_cache:
          key: external-dependencies-package-cache-<< parameters.base-cache-prefix >>-<< parameters.lib-name >>-{{ checksum "lib.version" }}

      - run:
          name: Get << parameters.lib-name >> tag from Github
          command: |
            test -e /tmp/workspace/download/<< parameters.lib-category >>/<< parameters.lib-name >>/<< parameters.lib-name >>.<< parameters.lib-release-package-extension >> \
            && echo file exists, skipping \
            || \
            (wget -O /tmp/workspace/download/<< parameters.lib-category >>/<< parameters.lib-name >>/<< parameters.lib-name >>.<< parameters.lib-release-package-extension >> https://github.com/<< parameters.lib-github-org >>/<< parameters.lib-name >>/archive/<< parameters.lib-release >>.<< parameters.lib-release-package-extension >> && \
            cp ~/project/lib.version /tmp/workspace/download/<< parameters.lib-category >>/<< parameters.lib-name >>/ && \
            cd /tmp/workspace/download/<< parameters.lib-category >>/<< parameters.lib-name >> && \
            echo "lib-package=<< parameters.lib-name >>.<< parameters.lib-release-package-extension >>" >>lib.version && \
            echo "lib-package-sha256=$(sha256sum << parameters.lib-name >>.<< parameters.lib-release-package-extension >>  | cut -d " " -f 1)" >>lib.version)

      ## TODO test file existance before cache save

      - save_cache:
          key: external-dependencies-package-cache-<< parameters.base-cache-prefix >>-<< parameters.lib-name >>-{{ checksum "lib.version" }}
          paths:
            - /tmp/workspace/download/<< parameters.lib-category >>/<< parameters.lib-name >>/

      # - run:
      #     command: |
      #       ls /tmp/workspace/download/<< parameters.lib-category >>/<< parameters.lib-name >>/
      #       cat /tmp/workspace/download/<< parameters.lib-category >>/<< parameters.lib-name >>/lib.version

  libs-external-unpack:
    description: "TBA"
    parameters:
      base-workplace-download-dir:
        type: string
        default: /tmp/workspace/download
      base-build-dir:
        type: string
        default: ~/project/build
      base-cache-prefix:
        type: string
        default: v01
      lib-github-org:
        type: string
        default: RedisLabsModules
      lib-name:
        type: string
        default: rejson
      lib-release-package-extension:
        type: string
        default: zip
      lib-category:
        type: string
        default: libs
    steps:
      - run:
          name: Create << parameters.lib-name >> build directory
          command: mkdir -p << parameters.base-build-dir >>/<< parameters.lib-category >>/<< parameters.lib-name >>

      - run:
          name: exit 2
          command: |
            echo << parameters.base-workplace-download-dir >>
            echo << parameters.base-build-dir >>

      - run:
          name: Unpack << parameters.lib-name >>
          command: |
            unzip -q << parameters.base-workplace-download-dir >>/<< parameters.lib-category >>/<< parameters.lib-name >>/<< parameters.lib-name >>.zip -d << parameters.base-build-dir >>/<< parameters.lib-category >>/<< parameters.lib-name >>

      - run:
          name: exit 2
          command: |
            ls << parameters.base-build-dir >>/<< parameters.lib-category >>/<< parameters.lib-name >>
            exit 2

jobs:

  base:
    executor: python-executor

    steps:
      - executor-python-setup-dependencies

      - *attach_workspace

      - checkout

      # - run:
      #     name: Process project env vars
      #     command: |
      #       echo "export lib_redis_release=5.0.2" >>/tmp/workspace/new-env-vars
      #       echo "export lib_rejson_release=08b10ce3045f9b24cf69ae00d25bee18f8807154" >>/tmp/workspace/new-env-vars
      #       echo "export lib_redex_release=f2d35edf438f1ac2279c312056589ddf83af6efc" >>/tmp/workspace/new-env-vars
      #       echo "export lib_redisearch_release=v1.4.2" >>/tmp/workspace/new-env-vars
      #       echo "export lib_redisgraph_release=v1.0.4" >>/tmp/workspace/new-env-vars
      #       echo "export lib_redisml_release=9bc5814ab3fcc8ea33edd0c060c0f84eead05c28" >>/tmp/workspace/new-env-vars
      #       echo "export lib_rebloom_release=955989f38778916f1bde0dc6998626333233d283" >>/tmp/workspace/new-env-vars
      #       cat /tmp/workspace/new-env-vars >> $BASH_ENV

      - run:
          name: move project config
          command: |
            test -e config.yaml && \
            cp config.yaml /tmp/workspace || \
            touch /tmp/workspace/config.yaml

      # - run: cat /tmp/workspace/new-env-vars >> $BASH_ENV
      # - run: mkdir -p /tmp/workspace/download/

      # - run:
      #     name: lib_redis_release
      #     command: |
      #       echo $lib_redis_release
      #       echo ${lib_redis_release}
      #       echo "${lib_redis_release}"
      #       echo "$lib_redis_release"

      - libs-external-get:
          lib-github-org: $(yq -r .libs.redis.github.org /tmp/workspace/config.yaml)
          lib-name: redis
          lib-release: $(yq -r .libs.redis.github.release /tmp/workspace/config.yaml)

      - libs-external-unpack:
          lib-name: redis



      - libs-external-get:
          lib-name: rejson
          lib-release: $(yq -r .libs.rejson.github.release /tmp/workspace/config.yaml)

      - libs-external-get:
          lib-github-org: $(yq -r .utils.bats.github.org /tmp/workspace/config.yaml)
          lib-name: bats
          lib-release: $(yq -r .utils.bats.github.release /tmp/workspace/config.yaml)
          lib-category: utils

      # - libs-external-get:
      #     lib-name: redex
      #     lib-release: $lib_redex_release

      - run:
          name: exit 2
          command: |
            exit 2




      - persist_to_workspace:
          root: *workspace_root
          paths:
            - config.yaml

  lint:
    executor: node-executor

    steps:
      - checkout

      - restore_cache:
          keys:
            - dependencies-npm-cache-v1-{{ checksum "package-lock.json" }}
            - dependencies-npm-cache-v1-

      - run:
            name: Install NPM
            command: |
                npm install

      - save_cache:
          key: dependencies-npm-cache-v1-{{ checksum "package-lock.json" }}
          paths:
            - ./node_modules

      - run:
          name: Run linting
          command: npm run lint


      # - run:
      #     name: QQQQ
      #     command: |
      #       echo TEST1
      #       echo $TEST1
      #       echo TEST2
      #       echo $TEST2

      # - run:
      #     name: temp exit
      #     command: |
      #       ls build/download/

      #       exit 2

      # - restore_cache:
      #     key: external-dependencies-cache-v1-rejson-08b10ce3045f9b24cf69ae00d25bee18f8807154

      # - run:
      #     name: Get module tag from Github
      #     command: |
      #       test -e build/download/rejson.zip \
      #       && echo file exists, skipping \
      #       || \
      #       wget -O build/download/rejson.zip https://github.com/RedisLabsModules/rejson/archive/08b10ce3045f9b24cf69ae00d25bee18f8807154.zip

      # - save_cache:
      #     key: external-dependencies-cache-v1-rejson-08b10ce3045f9b24cf69ae00d25bee18f8807154
      #     paths:
      #       - build/download/rejson.zip


      # - libs-external-get:
      #     lib-github-org: antirez
      #     lib-name: redis
      #     lib-release: 5.0.2

      # - libs-external-get:
      #     lib-name: rejson
      #     lib-release: ${lib_rejson_release}

      # - libs-external-get:
      #     lib-name: redex
      #     lib-release: ${lib_redex_release}

      # - libs-external-get:
      #     lib-name: RediSearch
      #     lib-release: ${lib_redisearch_release}

      # - libs-external-get:
      #     lib-name: RedisGraph
      #     lib-release: ${lib_redisgraph_release}

      # - libs-external-get:
      #     lib-name: redis-ml
      #     lib-release: ${lib_redisml_release}

      # - libs-external-get:
      #     lib-name: rebloom
      #     lib-release: ${lib_rebloom_release}

      # - run:
      #     name: temp exit
      #     command: |
      #       ls build/download/

      #       exit 2

  test-redis-core:
    docker:
      - image: python:3.7.1
      - image: matijaboban/docker-redismoduls:$CIRCLE_SHA1
        # command: [--sysctl vm.overcommit_memory=1]

    working_directory: ~/project

    steps:
      - executor-python-setup-dependencies

      - *attach_workspace

      - checkout

      - run: |
          apt-get update && apt-get install -y curl

      - run:
          name: Install goss
          command: |
            curl -fsSL https://goss.rocks/install | sh
            goss -version

      - run: |
          apt-get update && apt-get install -y redis-tools
          echo "CONFIG SET save ''" | redis-cli -x

      - run: redis-cli info

      - run:
          name: Test goss
          command: goss validate

      - libs-external-get:
          lib-github-org: $(yq -r .utils.bats.github.org /tmp/workspace/config.yaml)
          lib-name: bats
          lib-release: $(yq -r .utils.bats.github.release /tmp/workspace/config.yaml)

      - run:
          name: Install Bats
          command: |
            mkdir -p util/bats
            unzip -q /tmp/workspace/download/bats/*.zip -d ~/project/util/bats
            cd ~/project/util/bats/b*
            ./install.sh /usr/local
            bats --version



  test-redis-rejson:
    docker:
      - image: python:3.7.1
      - image: matijaboban/docker-redismoduls:$CIRCLE_SHA1

    working_directory: ~/project

    steps:
      - *attach_workspace

      - checkout

      - run: |
          apt-get update && apt-get install -y curl

      - run:
          name: Install goss
          command: |
            curl -fsSL https://goss.rocks/install | sh
            goss -version

      - run: |
          apt-get update && apt-get install -y redis-tools
          echo "CONFIG SET save ''" | redis-cli -x

      - run: redis-cli info

      - run:
          name: Test goss
          command: goss validate

  test-redis-redisearch:
    docker:
      - image: python:3.7.1
      - image: matijaboban/docker-redismoduls:$CIRCLE_SHA1

    working_directory: ~/project

    steps:
      - *attach_workspace

      - checkout

      - run: |
          apt-get update && apt-get install -y curl

      - run:
          name: Install goss
          command: |
            curl -fsSL https://goss.rocks/install | sh
            goss -version

      - run: |
          apt-get update && apt-get install -y redis-tools
          echo "CONFIG SET save ''" | redis-cli -x

      - run: redis-cli info

      - run:
          name: Test goss
          command: goss validate

  test-redis-redisbloom:
    docker:
      - image: python:3.7.1
      - image: matijaboban/docker-redismoduls:$CIRCLE_SHA1

    working_directory: ~/project

    steps:
      - *attach_workspace

      - checkout

      - run: |
          apt-get update && apt-get install -y curl

      - run:
          name: Install goss
          command: |
            curl -fsSL https://goss.rocks/install | sh
            goss -version

      - run: |
          apt-get update && apt-get install -y redis-tools
          echo "CONFIG SET save ''" | redis-cli -x

      - run: redis-cli info

      - run:
          name: Test goss
          command: goss validate

  build-redis:
    executor: alpine-executor

    steps:
      - executor-alpine-setup-dependencies

      - *attach_workspace

      - libs-external-get:
          lib-github-org: $(yq -r .libs.redis.github.org /tmp/workspace/config.yaml)
          lib-name: redis
          lib-release: $(yq -r .libs.redis.github.release /tmp/workspace/config.yaml)

      - restore_cache:
          key: external-dependencies-compile-cache-v05-redis-q1

      - run:
          name: Unpack external lib
          command: |
            test -e /tmp/workspace/compiled/core/redis-server \
            && (echo Compiled assets found, skipping, skipping && exit 0) || \
            (unzip -q /tmp/workspace/download/redis/*.zip -d ~/project/build/ && \
            mv ~/project/build/* ~/project/build/redis)

      - run:
          name: Pre-build updates
          command: |
            test -e /tmp/workspace/compiled/core/redis-server \
            && (echo Compiled assets found, skipping, skipping && exit 0) || \
            (grep -q '^#define CONFIG_DEFAULT_PROTECTED_MODE 1$' ~/project/build/redis/src/server.h && \
            sed -ri 's!^(#define CONFIG_DEFAULT_PROTECTED_MODE) 1$!\1 0!' ~/project/build/redis/src/server.h && \
            grep -q '^#define CONFIG_DEFAULT_PROTECTED_MODE 0$' ~/project/build/redis/src/server.h)

      - run:
          name: Build module
          command: |
            test -e /tmp/workspace/compiled/core/redis-server \
            && (echo Compiled assets found, skipping, skipping && exit 0) || \
            make -C ~/project/build/redis/src -j 8

      ## Tests are prepared with brute-force removal of some
      ## desting due to musl libc instead of glibc on Alpine
      ## https://github.com/antirez/redis/issues/2814
      ## Could posible be solved in the future by adding glibc
      ## or a dedicated glibc capable glibc docker like
      ## https://github.com/frol/docker-alpine-glibc
      - run:
          name: Test redis core
          command: |
            test -e /tmp/workspace/compiled/core/redis-server \
            && (echo Compiled assets found, skipping, skipping && exit 0) || \
            (cd ~/project/build/redis && \
            rm tests/integration/aof.tcl && \
            rm tests/integration/logging.tcl && \
            rm tests/unit/slowlog.tcl && \
            mv tests/test_helper.tcl tests/test_helper.tcl.original && \
            egrep -v 'integration/(aof|logging)' tests/test_helper.tcl.original > tests/test_helper.tcl && \
            rm tests/test_helper.tcl.original && \
            mv tests/test_helper.tcl tests/test_helper.tcl.original && \
            egrep -v 'unit/slowlog' tests/test_helper.tcl.original > tests/test_helper.tcl && \
            make test -j 2)

      # - run:
      #     name: Copy compiled module to workspace
      #     command: |
      #       mkdir -p /tmp/workspace/compiled/core/
      #       cp ~/project/build/RediSearch/compile/*.so /tmp/workspace/compiled/modules/

      - run:
          name: Copy compiled assets to workspace
          command: |
            test -e /tmp/workspace/compiled/core/redis-server \
            && (echo Compiled assets found, skipping, skipping && exit 0) || \
            (mkdir -p /tmp/workspace/compiled/core/utils && \
            cd ~/project/build/redis && \
            cp src/redis-benchmark /tmp/workspace/compiled/core/ && \
            cp src/redis-check-aof /tmp/workspace/compiled/core/ && \
            cp src/redis-check-rdb /tmp/workspace/compiled/core/ && \
            cp src/redis-cli /tmp/workspace/compiled/core/ && \
            cp src/redis-sentinel /tmp/workspace/compiled/core/ && \
            cp src/redis-server /tmp/workspace/compiled/core/ && \
            cp -r utils/ /tmp/workspace/compiled/core/ && \
            cp redis.conf /tmp/workspace/compiled/core/ && \
            cp redis.conf /tmp/workspace/compiled/core/)

      - persist_to_workspace:
          root: *workspace_root
          paths:
            - compiled/core

      - save_cache:
          key: external-dependencies-compile-cache-v05-redis-q1
          paths:
            - /tmp/workspace/compiled/core

      # - run:
      #     name: temp exit
      #     command: |
      #       ls /tmp/workspace/compiled/core/
      #       exit 2
      #
      #
    #   - *attach_workspace

      # - run:
      #     name: Install Dependencies
      #     command: |
      #       apt-get update
      #       apt-get install -y cmake

      # - run:
      #     name: Create workspace directory
      #     command: |
      #       mkdir -p /tmp/workspace/compiled/core

      # - run:
      #     name: Get module tag from Github
      #     command: |
      #       curl -OL https://github.com/antirez/redis/archive/5.0.2.tar.gz
      #       tar xzf *.tar.gz
      #
      # - run:
      #     name: Get module tag from Github
      #     command: |
      #       cp /tmp/workspace/download/redis-${lib_redis_release}.zip ~/project/
      #       unzip -q redis-${lib_redis_release}.zip


    # disable Redis protected mode [1] as it is unnecessary in context of Docker
    # (ports are not automatically exposed when running inside Docker, but rather explicitly by specifying -p / -P)
    # [1]: https://github.com/antirez/redis/commit/edd4d555df57dc84265fdfb4ef59a4678832f6da
      # grep -q '^#define CONFIG_DEFAULT_PROTECTED_MODE 1$' /usr/src/redis/src/server.h; \
      # sed -ri 's!^(#define CONFIG_DEFAULT_PROTECTED_MODE) 1$!\1 0!' /usr/src/redis/src/server.h; \
      # grep -q '^#define CONFIG_DEFAULT_PROTECTED_MODE 0$' /usr/src/redis/src/server.h; \

      # - run:
      #     name: Pre-build updates
      #     command: |
      #       grep -q '^#define CONFIG_DEFAULT_PROTECTED_MODE 1$' ~/project/r*/src/server.h
      #       sed -ri 's!^(#define CONFIG_DEFAULT_PROTECTED_MODE) 1$!\1 0!' ~/project/r*/src/server.h
      #       grep -q '^#define CONFIG_DEFAULT_PROTECTED_MODE 0$' ~/project/r*/src/server.h

      # - run:
      #     name: Build redis core
      #     command: |
      #       cd ~/project/r*
      #       make

      # - run:
      #     name: Test redis core
      #     command: |
      #       cd ~/project/r*
      #       make test

      # - run:
      #     name: Test redis sentinel
      #     command: |
      #       cd ~/project/r*
      #       sh runtest
      #       sh runtest-sentinel

      # - run:
      #     name: Move compiled assets to workspace
      #     command: |
      #       cd ~/project/r*
      #       cp src/redis-benchmark ~/project/build/redis/core/
      #       cp src/redis-check-aof ~/project/build/redis/core/
      #       cp src/redis-check-rdb ~/project/build/redis/core/
      #       cp src/redis-cli ~/project/build/redis/core/
      #       cp src/redis-sentinel ~/project/build/redis/core/
      #       cp src/redis-server ~/project/build/redis/core/
      #       cp redis.conf ~/project/build/redis/core/
      #       cp sentinel.conf ~/project/build/redis/core/

      # - run:
      #     name: Make install and move
      #     command: |
      #       cd ~/project/
      #       tar -czvf /tmp/workspace/build/redis/core/core.tar.gz  r*/


      # - run: |
      #     echo "build-redis"

      # - run: mkdir -p ~/project/build/redis/core
      # - run: echo "build-redis!" > ~/project/build/redis/core/echo-output.txt

      # - run: |
      #     ls
      #     cd ~/project/build
      #     ls

      # # Persist the specified paths (workspace/echo-output) into the workspace for use in downstream job.
      # - persist_to_workspace:
      #     # Must be an absolute path, or relative path from working_directory. This is a directory on the container which is
      #     # taken to be the root directory of the workspace.
      #     root: *workspace_root
      #     # Must be relative path from root
      #     paths:
      #       - compiled

  build-redisearch:
    executor: alpine-executor

    steps:
      - executor-alpine-setup-dependencies

      - *attach_workspace

      - libs-external-get:
          lib-name: RediSearch
          lib-release: $(yq -r .libs.redisearch.github.release /tmp/workspace/config.yaml)

      - restore_cache:
          key: external-dependencies-compile-cache-v01-redisearch-q1

      - run:
          name: Unpack external lib
          command: |
            test -e /tmp/workspace/compiled/modules/redisearch.so \
            && (echo file exists, skipping && exit 0) || \
            (unzip -q /tmp/workspace/download/RediSearch/*.zip -d ~/project/build && \
            mv ~/project/build/*  ~/project/build/RediSearch)

      - run:
          name: Build module
          command: |
            test -e /tmp/workspace/compiled/modules/redisearch.so \
            && (echo file exists, skipping && exit 0) || \
            (mkdir -p ~/project/build/RediSearch/compile && \
            cd ~/project/build/RediSearch/compile && \
            cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo && \
            make -j 8)

      # - run:
      #     name: Test module | TODO
      #     command: |
      #       pip install git+https://github.com/RedisLabsModules/RLTest
      #       make test

      - run:
          name: Copy compiled module to workspace
          command: |
            test -e /tmp/workspace/compiled/modules/redisearch.so \
            && echo file exists, skipping || \
            (mkdir -p /tmp/workspace/compiled/modules/ && \
            cp ~/project/build/RediSearch/compile/*.so /tmp/workspace/compiled/modules/)

      - save_cache:
          key: external-dependencies-compile-cache-v01-redisearch-q1
          paths:
            - /tmp/workspace/compiled/modules/redisearch.so

      - persist_to_workspace:
          root: *workspace_root
          paths:
            - compiled/modules

      # - run: exit 2




      # - run:
      #     name: Create workspace directory
      #     command: |
      #       mkdir -p /tmp/cache/build/redis/modules
      #       mkdir -p /tmp/workspace/build/redis/modules

      # - run:
      #     name: Get module tag from Github
      #     command: |
      #       curl -OL https://github.com/RedisLabsModules/RediSearch/archive/v1.4.2.tar.gz
      #       tar xzf *.tar.gz

      # - run:
      #     name: Build module
      #     command: |
      #       cd ~/project/R*
      #       mkdir build
      #       cd build
      #       cmake .. -DCMAKE_BUILD_TYPE=RelWithDebInfo
      #       make
      #       cp *.so /tmp/workspace/build/redis/modules/

      # - persist_to_workspace:
      #     root: *workspace_root
      #     paths:
      #       - build

  build-redisml:
    executor: python-executor
    ## TODO: has to be build on Alpine to avoid: # Module /usr/src/redis/modules/redis-ml.so failed to load: Error relocating /usr/src/redis/modules/redis-ml.so: __strndup: symbol not found
    steps:
      - executor-python-setup-dependencies

      - *attach_workspace

      - libs-external-get:
          lib-name: redis-ml
          lib-release: $(yq -r .libs.redisml.github.release /tmp/workspace/config.yaml)

      - run:
          name: Unpack external lib
          command: |
            unzip -q /tmp/workspace/download/redis-ml/r*.zip -d ~/project/build/ && \
            mv ~/project/build/r*  ~/project/build/redis-ml

      - run:
          name: Build module
          command: |
            make -C ~/project/build/redis-ml/src -j 8

      - run:
          name: Copy compiled module to workspace
          command: |
            mkdir -p /tmp/workspace/compiled/modules/
            cp ~/project/build/redis-ml/src/*.so /tmp/workspace/compiled/modules/

      - persist_to_workspace:
          root: *workspace_root
          paths:
            - compiled/modules

    # steps:
    #   - *attach_workspace

    #   - run:
    #       name: Install Dependencies
    #       command: |
    #         apt-get update
    #         apt-get install -y cmake
    #         apt-get install -y zip
    #         apt-get install -y libatlas-base-dev

    #   - run:
    #       name: Create workspace directory
    #       command: |
    #         mkdir -p ~/project/build/redis/modules

    #   - run:
    #       name: Get module tag from Github
    #       command: |
    #         curl -OL https://github.com/RedisLabsModules/redis-ml/archive/master.zip
    #         unzip *.zip


    #   - run:
    #       name: Build module
    #       command: |
    #         cd ~/project/r*/src
    #         make
    #         cp *.so ~/project/build/redis/modules/

    #   - persist_to_workspace:
    #       root: *workspace_root
    #       paths:
    #         - redis

  build-redisbloom:
    executor: alpine-executor

    steps:
      - executor-alpine-setup-dependencies

      - *attach_workspace

      - libs-external-get:
          lib-name: rebloom
          lib-release: $(yq -r .libs.redisbloom.github.release /tmp/workspace/config.yaml)

      - run:
          name: Unpack external lib
          command: |
            unzip -q /tmp/workspace/download/rebloom/r*.zip -d ~/project/build/ && \
            mv ~/project/build/r*  ~/project/build/rebloom

      - run:
          name: Build module
          command: |
            make -C ~/project/build/rebloom -j 8;

      - run:
          name: Copy compiled module to workspace
          command: |
            mkdir -p /tmp/workspace/compiled/modules/
            cp ~/project/build/rebloom/*.so /tmp/workspace/compiled/modules/

      - persist_to_workspace:
          root: *workspace_root
          paths:
            - compiled/modules




      # - run:
      #     name: Install Dependencies
      #     command: |
      #       apt-get update
      #       apt-get install -y zip

      # - run:
      #     name: Create workspace directory
      #     command: |
      #       mkdir -p ~/project/build/redis/modules

      # - run:
      #     name: Get module tag from Github
      #     command: |
      #       curl -OL https://github.com/RedisLabsModules/rebloom/archive/master.zip
      #       unzip *.zip

      # - run:
      #     name: Build module
      #     command: |
      #       cd ~/project/r*
      #       make
      #       cp *.so ~/project/build/redis/modules/

      # - persist_to_workspace:
      #     root: *workspace_root
      #     paths:
      #       - redis

  build-rejson:
    executor: alpine-executor

    steps:
      - executor-alpine-setup-dependencies

      - *attach_workspace

      - libs-external-get:
          lib-name: rejson
          lib-release: $(yq -r .libs.rejson.github.release /tmp/workspace/config.yaml)

      - run:
          name: Unpack external lib
          command: |
            unzip -q /tmp/workspace/download/rejson/r*.zip -d ~/project/build/ && \
            mv ~/project/build/r*  ~/project/build/rejson

      - run:
          name: Build module
          command: |
            make -C ~/project/build/rejson/src -j 8;

      - run:
          name: Copy compiled module to workspace
          command: |
            mkdir -p /tmp/workspace/compiled/modules/
            cp ~/project/build/rejson/src/*.so /tmp/workspace/compiled/modules/


      # - run:
      #     name: exit 2
      #     command: |
      #       ls ~/project/build/rejson
      #       ls /tmp/workspace/compiled/rejson/


      # - restore_cache:
      #     keys:
      #       - v04-rejson--08b10ce3045f9b24cf69ae00d25bee18f8807154

      # - run:
      #     name: Build module
      #     command: |
      #       test -e /tmp/workspace/build/redis/modules/rejson/ \
      #       && ls /tmp/workspace/build/redis/modules/rejson/ \
      #       || echo file doesnt exist, skipping

      # - run:
      #     name: Process external lib
      #     command: |
      #       source ${BASH_ENV}
      #       unzip -q /tmp/workspace/download/rejson-${lib_rejson_release}.zip -d ~/project/ && \
      #       mv ~/project/r* ~/project/rejson

      # - run:
      #     name: Build module
      #     command: |
      #       cd ~/project/rejson/src && \
      #       make

      # - run:
      #     name: Copy compiled module to workspace
      #     command: |
      #       mkdir -p /tmp/workspace/build/redis/modules/rejson/
      #       cp ~/project/rejson/src/*.so /tmp/workspace/build/redis/modules/rejson/

      # - save_cache:
      #     key: v04-rejson--08b10ce3045f9b24cf69ae00d25bee18f8807154
      #     paths:
      #       - /tmp/workspace/build/redis/modules/rejson/

      # - run:
      #     name: add user and group for consistent id assigned
      #     command: |
      #       addgroup -S circleci && adduser -S -G circleci circleci

      # - *attach_workspace

      # - executor-alpine-setup-dependencies


      # - run:
      #     name: Create workspace directory
      #     command: |
      #       exit 2
      #       mkdir -p /tmp/workspace/build/redis/modules

      # - restore_cache:
      #     keys:
      #       - v03-rejson--08b10ce3045f9b24cf69ae00d25bee18f8807154

      # - run:
      #     name: Build module
      #     command: |
      #       pwd
      #       ls

      # - run:
      #     name: Get module tag from Github
      #     command: |
      #       wget -O rejson.zip https://github.com/RedisLabsModules/rejson/archive/08b10ce3045f9b24cf69ae00d25bee18f8807154.zip
      #       unzip *.zip
      #       rm *.zip
      #       mv r* rejson

      # - run:
      #     name: Build module
      #     command: |
      #       pwd
      #       ls
      #       cd ~/project/rejson/src
      #       make

      # - run:
      #     name: Perm
      #     command: |
      #       chmod -R 777 /cache/build/redis/modules

      # - save_cache:
      #     key: v04-rejson--08b10ce3045f9b24cf69ae00d25bee18f8807154
      #     paths:
      #       - rejson/src/rejson.so

      # - run:
      #     name: Copy compiled module to workspace
      #     command: |
      #       cp ~/project/r*/src/*.so /tmp/workspace/build/redis/modules/

      - persist_to_workspace:
          root: *workspace_root
          paths:
            - compiled/modules

  build-redistimeseries:
    executor: alpine-executor

    steps:
      - executor-alpine-setup-dependencies

      - *attach_workspace

      - libs-external-get:
          lib-name: redis-timeseries
          lib-release: $(yq -r .libs.redistimeseries.github.release /tmp/workspace/config.yaml)

      # - restore_cache:
      #     key: external-dependencies-compile-cache-v01-redistimeseries-q1

      - run:
          name: Unpack external lib
          command: |
            test -e /tmp/workspace/compiled/modules/redis-tsdb-module.so \
            && (echo file exists, skipping && exit 0) || \
            (unzip -q /tmp/workspace/download/redis-timeseries/*.zip -d ~/project/build && \
            mv ~/project/build/*  ~/project/build/redis-timeseries)

      - run:
          name: Build module
          command: |
            test -e /tmp/workspace/compiled/modules/redis-tsdb-module.so \
            && (echo file exists, skipping && exit 0) || \
            (cd ~/project/build/redis-timeseries/RedisModulesSDK/ && \
            curl -OL https://github.com/RedisLabs/RedisModulesSDK/archive/master.zip && \
            unzip *.zip && \
            mv R*/* . && \
            cd ~/project/build/redis-timeseries/src && \
            make all)

      # - run:
      #     name: Test module | TODO
      #     command: |
      #       test -e /tmp/workspace/compiled/modules/redis-tsdb-module.so \
      #       && (echo file exists, skipping && exit 0) || \
      #       (cd ~/project/build/redis-timeseries/src && \
      #       pip install -r tests/requirements.txt && \
      #       make tests)

      - run:
          name: Copy compiled module to workspace
          command: |
            test -e /tmp/workspace/compiled/modules/redis-tsdb-module.so \
            && echo file exists, skipping || \
            (mkdir -p /tmp/workspace/compiled/modules/ && \
            cp ~/project/build/redis-timeseries/src/*.so /tmp/workspace/compiled/modules/)

      # - save_cache:
      #     key: external-dependencies-compile-cache-v01-redistimeseries-q1
      #     paths:
      #       - /tmp/workspace/compiled/modules/redis-tsdb-module.so

      - persist_to_workspace:
          root: *workspace_root
          paths:
            - compiled/modules




  #     - run:
  #         name: Install Dependencies
  #         command: |
  #           apt-get update
  #           apt-get install -y zip

  #     - run:
  #         name: Create workspace directory
  #         command: |
  #           mkdir -p ~/project/build/redis/modules

  #     - run:
  #         name: Get module tag from Github
  #         command: |
  #           curl -OL https://github.com/RedisLabsModules/redis-timeseries/archive/master.zip
  #           unzip *.zip

  #     - run:
  #         name: Get utility SDK from Github
  #         command: |
  #           cd r*/RedisModulesSDK/
  #           curl -OL https://github.com/RedisLabs/RedisModulesSDK/archive/master.zip
  #           unzip *.zip
  #           mv R*/* .

  #     - run:
  #         name: Build module
  #         command: |
  #           cd ~/project/r*/src
  #           make
  #           cp *.so ~/project/build/redis/modules/

  #     - persist_to_workspace:
  #         root: *workspace_root
  #         paths:
  #           - redis

  build-redex:
    executor: python-executor

    steps:
      - executor-python-setup-dependencies

      - *attach_workspace

      - libs-external-get:
          lib-name: redex
          lib-release: $(yq -r .libs.redex.github.release /tmp/workspace/config.yaml)

      - run:
          name: Unpack external lib
          command: |
            unzip -q /tmp/workspace/download/redex/*.zip -d ~/project/build/ && \
            mv ~/project/build/*  ~/project/build/redex

      - run:
          name: Build module
          command: |
            make -C ~/project/build/redex

      - run:
          name: Copy compiled module to workspace
          command: |
            mkdir -p /tmp/workspace/compiled/modules/
            cp ~/project/build/redex/src/*.so /tmp/workspace/compiled/modules/

      - persist_to_workspace:
          root: *workspace_root
          paths:
            - compiled/modules

  build-redisgraph:
    executor: python-executor
    ## TODO: has to be build on Alpine to avoid: # /root/project/build/RedisGraph/src/value.h:56:5: error: unknown type name 'int32_t'

    steps:
      - executor-python-setup-dependencies

      - *attach_workspace

      - libs-external-get:
          lib-name: RedisGraph
          lib-release: $(yq -r .libs.redisgraph.github.release /tmp/workspace/config.yaml)

      - restore_cache:
          key: external-dependencies-compile-cache-v02-redisgraph-q1

      - run:
          name: Unpack external lib
          command: |
            test -e /tmp/workspace/compiled/modules/redisgraph.so \
            && (echo file exists, skipping && exit 0) || \
            (unzip -q /tmp/workspace/download/RedisGraph/*.zip -d ~/project/build/ && \
            mv ~/project/build/*  ~/project/build/RedisGraph)

      - run:
          name: Build module
          command: |
            test -e /tmp/workspace/compiled/modules/redisgraph.so \
            && (echo file exists, skipping && exit 0) || \
            make -C ~/project/build/RedisGraph -j 8

      - run:
          name: Copy compiled module to workspace
          command: |
            test -e /tmp/workspace/compiled/modules/redisgraph.so \
            && (echo file exists, skipping && exit 0) || \
            (mkdir -p /tmp/workspace/compiled/modules/ && \
            cp ~/project/build/RedisGraph/src/*.so /tmp/workspace/compiled/modules/)

      - save_cache:
          key: external-dependencies-compile-cache-v02-redisgraph-q1
          paths:
            - /tmp/workspace/compiled/modules/redisgraph.so

      - persist_to_workspace:
          root: *workspace_root
          paths:
            - compiled/modules



      # - run:
      #     name: Install Dependencies
      #     command: |
      #       apt-get update
      #       apt-get install -y build-essential
      #       apt-get install -y cmake

      # - run:
      #     name: Create workspace directory
      #     command: |
      #       mkdir -p ~/project/build/redis/modules

      # - run:
      #     name: Get module tag from Github
      #     command: |
      #       curl -OL https://github.com/RedisLabsModules/RedisGraph/archive/v1.0.2.tar.gz
      #       tar xzf *.tar.gz

      # - run:
      #     name: Build module
      #     command: |
      #       cd ~/project/R*
      #       make
      #       cp src/*.so ~/project/build/redis/modules/

      # - persist_to_workspace:
      #     root: *workspace_root
      #     paths:
      #       - redis


  temptest:
    docker:
      - image: python:3.7.1

    working_directory: ~/project

    steps:
      - *attach_workspace

      - run: |
          echo "temptest"
          ls

      # - attach_workspace:
      #     # Must be absolute path or relative path from working_directory
      #     at: /project/workspace

      - run: |
          cd ~/project/build/redis
          ls
          cd core
          ls
          cd ../modules
          ls

      # - run: cat /project/workspace/echo-output


  build-docker:
    docker:
      - image: python:3.7.1

    working_directory: ~/project

    steps:
      - checkout

      - *attach_workspace

      - run:
          name: Check Environment Variables
          command: |
            if [[ -z "${DOCKER_LOGIN}" ]]; then
              echo "DOCKER_LOGIN is not set, will not be able to push image."
              exit 1
            fi

            if [[ -z "${DOCKER_PASSWORD}" ]]; then
              echo "DOCKER_PASSWORD is not set, will not be able to push image."
              exit 1
            fi

      - run:
          name: Docker Login
          command: docker login -u $DOCKER_LOGIN -p $DOCKER_PASSWORD docker.io

      - run: |
          cd ~/project/build/redis
          ls
          cd core
          ls
          cd ../modules
          ls

      # - run: cat /project/workspace/echo-output



  # test:
  #   build:
  #     docker:
  #       - image: matijaboban/docker-redismoduls:$CIRCLE_SHA1

  #     steps:
  #       - run:
  #           name: Install goss
  #           command: |
  #             # rather than give internet scripts SU rights, we install to local user bin and add to path
  #             mkdir ~/bin
  #             export GOSS_DST=~/bin
  #             export PATH=$PATH:~/bin
  #             curl -fsSL https://goss.rocks/install | sh
  #             goss -version

      # - docker-publish/publish:
      #     after_checkout:
      #       - run:
      #           name: Do this after checkout.
      #           command: echo "Did this after checkout"
      #     before_build:
      #       - run:
      #           name: Do this before the build.
      #           command: echo "Did this before the build"
      #     after_build:
      #       - run:
      #           name: Do this after the build.
      #           command: echo "Did this after the build"

  # build:

  #   steps:

  #     - run:
  #       name: Do this after checkout.
  #       command: echo "test"

  #     # - docker-publish/check
  #     #
  #     #
  #     - dockerprocess/publish


      # - docker-publish/publish:
      #   after_checkout:
      #     - run:
      #         name: Do this after checkout.
      #         command: echo "Did this after checkout"
      #   before_build:
      #     - run:
      #         name: Do this before the build.
      #         command: echo "Did this before the build"
      #   after_build:
      #     - run:
      #         name: Do this after the build.
      #         command: echo "Did this after the build"
    # executor: node-executor
    # - docker-publish/check

workflows:
  version: 2.1

  # docker_with_lifecycle:
  #   jobs:
      # steps:

      #   - checkout

      #   - docker-publish/publish:
      #       after_checkout:
      #         - run:
      #             name: Do this after checkout.
      #             command: echo "Did this after checkout"
      #       before_build:
      #         - run:
      #             name: Do this before the build.
      #             command: echo "Did this before the build"
      #         - run:
      #             name: docker-publish/check.
      #             command: docker-publish/check
      #       after_build:
      #         - run:
      #             name: Do this after the build.
      #             command: echo "Did this after the build"

  pre-build:
    jobs:
      - base
      - lint
      - build-redis:
          requires:
            - base
            - lint
      - build-redisearch:
          requires:
            - base
            - lint
      # - build-redisml:
      #     requires:
      #       - base
      #       - lint
      - build-redisbloom:
          requires:
            - base
            - lint
      - build-rejson:
          requires:
            - base
            - lint
      - build-redistimeseries:
          requires:
            - base
            - lint
      - build-redex:
          requires:
            - base
            - lint
      - build-redisgraph:
          requires:
            - base
            - lint

      # - temptest:
          # requires:
            # - build-redis
            # - build-redisearch
            # - build-redisml
            # - build-redisbloom
            # - build-rejson
            # - build-timeseries
            # - build-redex
            # - build-redisgraph

      # - build-docker:
      #     requires:
      #       - temptest


      - docker-publish/publish:
          requires:
            - build-redis
            - build-redisearch
            # - build-redisml
            - build-rejson
            - build-redisbloom
            - build-redisgraph
            - build-redex
            - build-redistimeseries
          after_checkout:
            - *attach_workspace

            # - run:
            #     name: location
            #     command: |
            #       cd /tmp/workspace/compiled/modules
            #       pwd

            # - run:
            #     name: Create workspace directory
            #     command: |
            #       mkdir -p ~/project/build/redis/modules
            #
            # - run:
            #     name: Create workspace directory
            #     command: |
            #       mkdir -p ~/project/build/redis/modules
            #
            # - run:
            #     name: Create workspace directory
            #     command: |
            #       sudo mkdir -p /tmp/workspace/build/redis/modules

            # - restore_cache:
            #     keys:
            #       - v1-rejson-4
            #     paths:
            #       - /tmp/cache/build/

            # - run:
            #     name: Do this after checkout.
            #     command: |
            #       cd /tmp/workspace/compiled/
            #       pwd
            #       ls

            - run:
                name: Do this after checkout.
                command: |
                  mkdir -p ~/project/build/compiled
                  cp -r /tmp/workspace/compiled/* ~/project/build/compiled/

      - test-redis-core:
          requires:
            - docker-publish/publish

      - test-redis-redisearch:
          requires:
            - docker-publish/publish

      - test-redis-redisbloom:
          requires:
            - docker-publish/publish

      - test-redis-rejson:
          requires:
            - docker-publish/publish




      # - build
      # - docker-publish/check
          # requires:
            # - lint

